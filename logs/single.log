[2025-09-26 16:59:29,043] [INFO] [real_accelerator.py:260:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2025-09-26 16:59:32,260] [INFO] [logging.py:107:log_dist] [Rank -1] [TorchCheckpointEngine] Initialized with serialization = False
[2025-09-26 16:59:32,925] [WARNING] [runner.py:220:fetch_hostfile] Unable to find hostfile, will proceed with training with local resources only.
[2025-09-26 16:59:32,925] [INFO] [runner.py:610:main] cmd = /home/victor/anaconda3/envs/nir/bin/python -u -m deepspeed.launcher.launch --world_info=eyJsb2NhbGhvc3QiOiBbMCwgMV19 --master_addr=127.0.0.1 --master_port=29500 --enable_each_rank_log=None opt_single.py
[2025-09-26 16:59:34,999] [INFO] [real_accelerator.py:260:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2025-09-26 16:59:38,080] [INFO] [logging.py:107:log_dist] [Rank -1] [TorchCheckpointEngine] Initialized with serialization = False
[2025-09-26 16:59:38,742] [INFO] [launch.py:146:main] WORLD INFO DICT: {'localhost': [0, 1]}
[2025-09-26 16:59:38,742] [INFO] [launch.py:152:main] nnodes=1, num_local_procs=2, node_rank=0
[2025-09-26 16:59:38,742] [INFO] [launch.py:163:main] global_rank_mapping=defaultdict(<class 'list'>, {'localhost': [0, 1]})
[2025-09-26 16:59:38,742] [INFO] [launch.py:164:main] dist_world_size=2
[2025-09-26 16:59:38,742] [INFO] [launch.py:168:main] Setting CUDA_VISIBLE_DEVICES=0,1
[2025-09-26 16:59:38,743] [INFO] [launch.py:256:main] process 4888 spawned with command: ['/home/victor/anaconda3/envs/nir/bin/python', '-u', 'opt_single.py', '--local_rank=0']
[2025-09-26 16:59:38,745] [INFO] [launch.py:256:main] process 4889 spawned with command: ['/home/victor/anaconda3/envs/nir/bin/python', '-u', 'opt_single.py', '--local_rank=1']
[2025-09-26 16:59:42,548] [INFO] [real_accelerator.py:260:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2025-09-26 16:59:42,578] [INFO] [real_accelerator.py:260:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2025-09-26 16:59:47,177] [INFO] [logging.py:107:log_dist] [Rank -1] [TorchCheckpointEngine] Initialized with serialization = False
[2025-09-26 16:59:47,184] [INFO] [comm.py:821:init_distributed] cdb=None
[2025-09-26 16:59:47,273] [INFO] [logging.py:107:log_dist] [Rank -1] [TorchCheckpointEngine] Initialized with serialization = False
[2025-09-26 16:59:47,280] [INFO] [comm.py:821:init_distributed] cdb=None
[2025-09-26 16:59:47,280] [INFO] [comm.py:852:init_distributed] Initializing TorchBackend in DeepSpeed with backend nccl
/home/victor/anaconda3/envs/nir/lib/python3.11/site-packages/torch/_utils.py:776: UserWarning: TypedStorage is deprecated. It will be removed in the future and UntypedStorage will be the only storage class. This should only matter to you if you are using storages directly.  To access UntypedStorage directly, use tensor.untyped_storage() instead of tensor.storage()
  return self.fget.__get__(instance, owner)()
/home/victor/anaconda3/envs/nir/lib/python3.11/site-packages/torch/_utils.py:776: UserWarning: TypedStorage is deprecated. It will be removed in the future and UntypedStorage will be the only storage class. This should only matter to you if you are using storages directly.  To access UntypedStorage directly, use tensor.untyped_storage() instead of tensor.storage()
  return self.fget.__get__(instance, owner)()
start benchmark
/home/victor/anaconda3/envs/nir/lib/python3.11/site-packages/torch/cuda/memory.py:303: FutureWarning: torch.cuda.reset_max_memory_allocated now calls torch.cuda.reset_peak_memory_stats, which resets /all/ peak memory stats.
  warnings.warn(
/home/victor/anaconda3/envs/nir/lib/python3.11/site-packages/torch/cuda/memory.py:303: FutureWarning: torch.cuda.reset_max_memory_allocated now calls torch.cuda.reset_peak_memory_stats, which resets /all/ peak memory stats.
  warnings.warn(
model:
[OPTModel(
  (decoder): OPTDecoder(
    (embed_tokens): Embedding(50272, 2048, padding_idx=1)
    (embed_positions): OPTLearnedPositionalEmbedding(2050, 2048)
    (final_layer_norm): LayerNorm((2048,), eps=1e-05, elementwise_affine=True)
    (layers): ModuleList(
      (0-23): 24 x OPTDecoderLayer(
        (self_attn): OPTAttention(
          (k_proj): Linear(in_features=2048, out_features=2048, bias=True)
          (v_proj): Linear(in_features=2048, out_features=2048, bias=True)
          (q_proj): Linear(in_features=2048, out_features=2048, bias=True)
          (out_proj): Linear(in_features=2048, out_features=2048, bias=True)
        )
        (activation_fn): ReLU()
        (self_attn_layer_norm): LayerNorm((2048,), eps=1e-05, elementwise_affine=True)
        (fc1): Linear(in_features=2048, out_features=8192, bias=True)
        (fc2): Linear(in_features=8192, out_features=2048, bias=True)
        (final_layer_norm): LayerNorm((2048,), eps=1e-05, elementwise_affine=True)
      )
    )
  )
), Linear(in_features=2048, out_features=50272, bias=False)]
stop benchmark
                               time  ...  max_memory_gpu_1
name                                 ...                  
start                   4713.874908  ...          0.000003
generator               4720.907541  ...          0.000004
max new tokens:8 start  4720.910295  ...          0.000005
max new tokens:8 stop   4725.370171  ...          0.000014

[4 rows x 5 columns]
-------Benchmark results-------
model name: deepspeed_single-1.3b
model size: 4.902, dtype: float32
mean inference time (s): 4.460
mean throughput (token/s): 19.731
data size: 11, batch size: 11, max len: 64
max new tokens: [8]
    inference time (s): 4.460
    throughput (token/s): 19.731

max memory allocated per device for generator (GB):            
    device 0: 4.902
    device 1: 0.000

max memory allocated per device for inference (GB):            
    device 0: 5.065
    device 1: 0.000

max memory allocated per device (GB):            
    device 0: 5.065
    device 1: 0.000
[2025-09-26 17:00:10,756] [INFO] [launch.py:351:main] Process 4889 exits successfully.
[2025-09-26 17:00:10,757] [INFO] [launch.py:351:main] Process 4888 exits successfully.
